<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meta Ads Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --navy:#003A70;
      --teal:#3ED6D3;
      --ink:#011627;
      --bg:#F5F7FA;
      --white:#FFFFFF;
      --line: rgba(1,22,39,.10);
    }
    body{margin:0;font-family:Poppins,sans-serif;background:var(--bg);color:var(--ink);}
    header{background:var(--navy);color:var(--white);padding:22px 20px;}
    .wrap{max-width:1200px;margin:0 auto;padding:18px;}
    .kpis{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:14px;margin-top:14px;}
    .card{background:var(--white);border-radius:16px;padding:14px 14px 16px;box-shadow:0 2px 10px rgba(0,0,0,.06);border-left:6px solid var(--teal);}
    .label{font-size:12px;opacity:.75;text-transform:uppercase;letter-spacing:.08em}
    .value{font-size:26px;font-weight:700;margin-top:6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px;}
    .panel{background:var(--white);border-radius:16px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);}
    .panel h3{margin:0 0 10px 0;font-size:14px}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(62,214,211,.18);font-size:12px;font-weight:600}
    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px;}
    table{border-collapse:collapse;width:100%;min-width:900px;background:#fff;}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);font-size:13px;white-space:nowrap;text-align:left;}
    th{font-size:12px;opacity:.8;text-transform:uppercase;letter-spacing:.06em;background:#fff;position:sticky;top:0;z-index:1;}
    td.num{text-align:right;font-variant-numeric:tabular-nums;}
    .muted{opacity:.75}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
    .tag.on{background:rgba(62,214,211,.18);}
    .tag.behind{background:rgba(255,99,132,.12);}
    @media (max-width:1100px){.kpis{grid-template-columns:1fr 1fr}.grid{grid-template-columns:1fr}}
    @media (max-width:650px){.kpis{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap">
      <div>
        <div style="font-weight:700;font-size:20px">Meta Ads Performance Dashboard</div>
      </div>
      <div class="pill" id="lastUpdated">Loading…</div>
    </div>
  </header>

  <main class="wrap">
    <section class="kpis">
      <div class="card"><div class="label">Meta Spend</div><div class="value" id="metaSpend">–</div></div>
      <div class="card"><div class="label">Meta Leads</div><div class="value" id="metaLeads">–</div></div>
      <div class="card"><div class="label">Meta CPL</div><div class="value" id="metaCpl">–</div></div>
      <div class="card"><div class="label">Budget Remaining</div><div class="value" id="metaRemaining">–</div></div>
      <div class="card"><div class="label">% Budget Used</div><div class="value" id="metaUsedPct">–</div></div>
    </section>

    <section class="grid">
      <div class="panel">
        <h3>Top Ad Sets by Spend</h3>
        <canvas id="topSpendChart"></canvas>
      </div>
      <div class="panel">
        <h3>Top Ad Sets by Leads</h3>
        <canvas id="topLeadsChart"></canvas>
      </div>
    </section>

    <section class="panel" style="margin-top:14px">
      <h3>Ad Set Performance (sorted by Leads)</h3>
      <div class="tableWrap">
        <table id="metaTable">
          <thead>
            <tr>
              <th>Ad Set</th>
              <th class="num">Spend</th>
              <th class="num">Leads</th>
              <th class="num">CPL</th>
              <th>Pace</th>
              <th>Delivery Strategy</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // Published Google Sheets CSV for Meta_Export
    const META_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaAQ-x37eMhwmwswWuQ89R6EW1DKxSD69UKqx8YXz2LxeSac0r8SSnWBKmO90BhbKpVFEC55I8RgyR/pub?gid=1218045846&single=true&output=csv";

    const money = (n) => Number(n || 0).toLocaleString("en-GB",{style:"currency",currency:"GBP"});
    const intFmt = (n) => Number(n || 0).toLocaleString("en-GB");

    function parseCsv(csvText){
      const rows = [];
      let row = [], field = "", inQuotes = false;
      for (let i = 0; i < csvText.length; i++){
        const c = csvText[i], next = csvText[i+1];
        if (c === '"' && inQuotes && next === '"'){ field += '"'; i++; continue; }
        if (c === '"'){ inQuotes = !inQuotes; continue; }
        if (c === ',' && !inQuotes){ row.push(field); field=""; continue; }
        if ((c === '\n' || c === '\r') && !inQuotes){
          if (field.length || row.length){ row.push(field); rows.push(row); }
          field=""; row=[];
          continue;
        }
        field += c;
      }
      if (field.length || row.length){ row.push(field); rows.push(row); }
      return rows.filter(r => r.some(x => String(x).trim() !== ""));
    }

    function num(x){
      const v = String(x ?? "").replace(/£/g,"").replace(/,/g,"").trim();
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function buildObjects(rows){
      const header = rows[0].map(h => h.trim().toLowerCase());
      const out = [];
      for (let i=1;i<rows.length;i++){
        const obj = {};
        for (let j=0;j<header.length;j++){
          obj[header[j]] = (rows[i][j] ?? "").trim();
        }
        out.push(obj);
      }
      return out;
    }

    function findRowByCampaign(allRows, campaignText){
      const target = String(campaignText).trim().toLowerCase();
      return allRows.find(r => String(r.campaign || "").trim().toLowerCase() === target) || null;
    }

    function findMonthlyRemainingRow(allRows){
      return allRows.find(r => String(r.campaign || "").trim().toLowerCase().startsWith("monthly budget")) || null;
    }

    let spendChart, leadsChart;

    function renderTable(items){
      const tbody = document.querySelector("#metaTable tbody");
      tbody.innerHTML = "";

      for (const it of items){
        const spend = num(it.spend);
        const leads = num(it.leads);
        const cpl = leads === 0 ? null : spend / leads;

        const pace = (it.pace || "").toLowerCase();
        const paceTag = pace.includes("behind") ? "behind" : "on";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.ad_set || "—"}</td>
          <td class="num">${money(spend)}</td>
          <td class="num">${intFmt(leads)}</td>
          <td class="num">${cpl === null ? "–" : money(cpl)}</td>
          <td><span class="tag ${paceTag}">${it.pace || "—"}</span></td>
          <td>${it.delivery_strategy || it.deliverystrategy || it.delivery || "—"}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderKpis(adSetRows, allRows){
      const totalSpend = adSetRows.reduce((s,it)=>s+num(it.spend),0);
      const totalLeads = adSetRows.reduce((s,it)=>s+num(it.leads),0);
      const cpl = totalLeads === 0 ? null : totalSpend / totalLeads;

      // Monthly budget comes from "Total Budget & Spend" row (Budget column)
      const totalRow = findRowByCampaign(allRows, "Total Budget & Spend");
      const monthlyBudget = totalRow ? num(totalRow.budget) : 0;

      // Monthly remaining is on "Monthly Budget Remaining" row, stored in the Ad Set column
      const remainingRow = findMonthlyRemainingRow(allRows);
      const remaining = remainingRow ? num(remainingRow.ad_set) : 0;

      const usedPct = (monthlyBudget > 0)
        ? ((monthlyBudget - remaining) / monthlyBudget) * 100
        : 0;

      document.getElementById("metaSpend").textContent = money(totalSpend);
      document.getElementById("metaLeads").textContent = intFmt(totalLeads);
      document.getElementById("metaCpl").textContent = cpl === null ? "–" : money(cpl);
      document.getElementById("metaRemaining").textContent = remaining ? money(remaining) : "–";
      document.getElementById("metaUsedPct").textContent = monthlyBudget ? usedPct.toFixed(1) + "%" : "–";
    }

    function renderCharts(items){
      const bySpend = [...items]
        .map(it => ({ name: it.ad_set, v: num(it.spend) }))
        .sort((a,b)=>b.v-a.v)
        .slice(0,8);

      const byLeads = [...items]
        .map(it => ({ name: it.ad_set, v: num(it.leads) }))
        .sort((a,b)=>b.v-a.v)
        .slice(0,8);

      if (spendChart) spendChart.destroy();
      if (leadsChart) leadsChart.destroy();

      spendChart = new Chart(document.getElementById("topSpendChart"),{
        type:"bar",
        data:{
          labels: bySpend.map(x=>x.name),
          datasets:[{ label:"£ Spent", data: bySpend.map(x=>x.v) }]
        },
        options:{
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{
            y:{
              title:{ display:true, text:"£ Spent" },
              ticks:{ callback:(value)=>"£" + Number(value).toLocaleString("en-GB") }
            }
          }
        }
      });

      leadsChart = new Chart(document.getElementById("topLeadsChart"),{
        type:"bar",
        data:{ labels: byLeads.map(x=>x.name), datasets:[{ label:"Leads", data: byLeads.map(x=>x.v) }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } } }
      });
    }

    async function load(){
      const res = await fetch(META_CSV_URL, { cache:"no-store" });
      if (!res.ok) throw new Error("Failed to load Meta CSV");
      const text = await res.text();
      if (text.trim().startsWith("<!DOCTYPE") || text.trim().startsWith("<html")){
        throw new Error("CSV URL returned HTML (not published or not public).");
      }

      const rows = parseCsv(text);
      const allRows = buildObjects(rows);

      // Only ad set rows for table/charts (ignores campaign headers + totals)
      const adSetRows = allRows.filter(r => r.ad_set && String(r.campaign || "").trim().toLowerCase() !== "monthly budget");

      // Sort table rows by most leads first
      adSetRows.sort((a,b) => num(b.leads) - num(a.leads));

      renderKpis(adSetRows, allRows);
      renderCharts(adSetRows);
      renderTable(adSetRows);

      document.getElementById("lastUpdated").textContent =
        "Updated: " + new Date().toLocaleString("en-GB");
    }

    load().catch(err => {
      document.getElementById("lastUpdated").textContent = "Error loading data";
      console.error(err);
    });
  </script>
</body>
</html>
