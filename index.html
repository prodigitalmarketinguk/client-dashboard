<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Paid Ads Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --navy:#003A70;
      --teal:#3ED6D3;
      --ink:#011627;
      --bg:#F5F7FA;
      --white:#FFFFFF;
      --line: rgba(1,22,39,.10);
    }
    body{margin:0;font-family:Poppins,sans-serif;background:var(--bg);color:var(--ink);}
    header{background:var(--navy);color:var(--white);padding:22px 20px;}
    .wrap{max-width:1200px;margin:0 auto;padding:18px;}
    .muted{opacity:.75}

    .topbar{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(62,214,211,.18);font-size:12px;font-weight:600;white-space:nowrap}

    .tabs{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}
    .tabbtn{
      border:1px solid rgba(255,255,255,.35);
      background:rgba(255,255,255,.08);
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-weight:600;
      cursor:pointer;
    }
    .tabbtn.active{
      background:#fff;
      color:var(--navy);
      border-color:#fff;
    }

    .kpis{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:14px;margin-top:14px;}
    .card{background:var(--white);border-radius:16px;padding:14px 14px 16px;box-shadow:0 2px 10px rgba(0,0,0,.06);border-left:6px solid var(--teal);}
    .label{font-size:12px;opacity:.75;text-transform:uppercase;letter-spacing:.08em}
    .value{font-size:26px;font-weight:700;margin-top:6px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px;}
    .panel{background:var(--white);border-radius:16px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);}
    .panel h3{margin:0 0 10px 0;font-size:14px}

    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px;}
    table{border-collapse:collapse;width:100%;min-width:900px;background:#fff;}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);font-size:13px;white-space:nowrap;vertical-align:middle;}
    th{
      font-size:12px;
      opacity:.8;
      text-transform:uppercase;
      letter-spacing:.06em;
      background:#fff;
      position:sticky;top:0;z-index:1;
      text-align:left;
    }
    th.num, td.num{ text-align:right; font-variant-numeric:tabular-nums; }
    td{ text-align:left; }

    .view{display:none;}
    .view.active{display:block;}

    @media (max-width:1100px){.kpis{grid-template-columns:1fr 1fr}.grid{grid-template-columns:1fr}}
    @media (max-width:650px){.kpis{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        
        <div style="display:flex; align-items:center; gap:12px;">
          <<img
  src="https://prodigitalmarketinguk.github.io/client-dashboard/assets/gac-logo.png"
  alt="Global Adventure Challenges logo"
  style="height:24px; width:auto; opacity:0.9;"
/>

          <div>
            <div style="font-weight:700;font-size:20px">Paid Ads Performance Dashboard</div>
            <div class="muted">Live from Google Sheets</div>
          </div>
        </div>
        <div class="pill" id="lastUpdated">Loading…</div>
      </div>

      <div class="tabs">
        <button class="tabbtn active" id="tab-meta" type="button">Meta Ads</button>
        <button class="tabbtn" id="tab-google" type="button">Google Ads</button>
        <button class="tabbtn" id="tab-meta-last" type="button">Meta Last Month</button>
        <button class="tabbtn" id="tab-google-last" type="button">Google Last Month</button>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- META CURRENT -->
    <section class="view active" id="view-meta">
      <section class="kpis">
        <div class="card"><div class="label">Meta Spend</div><div class="value" id="metaSpend">–</div></div>
        <div class="card"><div class="label">Meta Leads</div><div class="value" id="metaLeads">–</div></div>
        <div class="card"><div class="label">Meta CPL</div><div class="value" id="metaCpl">–</div></div>
        <div class="card"><div class="label">Budget Remaining</div><div class="value" id="metaRemaining">–</div></div>
        <div class="card"><div class="label">% Budget Used</div><div class="value" id="metaUsedPct">–</div></div>
      </section>

      <section class="grid">
        <div class="panel">
          <h3>Top Ad Sets by Spend</h3>
          <canvas id="metaSpendChart"></canvas>
        </div>
        <div class="panel">
          <h3>Top Ad Sets by Leads</h3>
          <canvas id="metaLeadsChart"></canvas>
        </div>
      </section>

      <section class="panel" style="margin-top:14px">
        <h3>Ad Set Performance (sorted by Leads)</h3>
        <div class="muted" style="margin-bottom:10px">Source: Meta_Export (published CSV)</div>
        <div class="tableWrap">
          <table id="metaTable">
            <thead>
              <tr>
                <th>Ad Set</th>
                <th class="num">Spend</th>
                <th class="num">Leads</th>
                <th class="num">CPL</th>
                <th>Pace</th>
                <th>Delivery Strategy</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- GOOGLE CURRENT -->
    <section class="view" id="view-google">
      <section class="kpis">
        <div class="card"><div class="label">Google Spend</div><div class="value" id="gSpend">–</div></div>
        <div class="card"><div class="label">Google Leads</div><div class="value" id="gLeads">–</div></div>
        <div class="card"><div class="label">Google CPL</div><div class="value" id="gCpl">–</div></div>
        <div class="card"><div class="label">Budget Remaining</div><div class="value" id="gRemaining">–</div></div>
        <div class="card"><div class="label">% Budget Used</div><div class="value" id="gUsedPct">–</div></div>
      </section>

      <section class="grid">
        <div class="panel">
          <h3>Top Ad Groups by Spend</h3>
          <canvas id="gSpendChart"></canvas>
        </div>
        <div class="panel">
          <h3>Top Ad Groups by Leads</h3>
          <canvas id="gLeadsChart"></canvas>
        </div>
      </section>

      <section class="panel" style="margin-top:14px">
        <h3>Ad Group Performance (sorted by Leads)</h3>
        <div class="muted" style="margin-bottom:10px">Source: Google_Export (published CSV)</div>
        <div class="tableWrap">
          <table id="gTable">
            <thead>
              <tr>
                <th>Ad Group</th>
                <th class="num">Spend</th>
                <th class="num">Leads</th>
                <th class="num">CPL</th>
                <th>Pace</th>
                <th>Delivery Strategy</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- META LAST MONTH (LITE) -->
    <section class="view" id="view-meta-last">
      <section class="kpis">
        <div class="card"><div class="label">Meta Spend</div><div class="value" id="metaLastSpend">–</div></div>
        <div class="card"><div class="label">Meta Leads</div><div class="value" id="metaLastLeads">–</div></div>
        <div class="card"><div class="label">Meta CPL</div><div class="value" id="metaLastCpl">–</div></div>
        <div class="card"><div class="label">Budget Remaining</div><div class="value">–</div></div>
        <div class="card"><div class="label">% Budget Used</div><div class="value">–</div></div>
      </section>

      <section class="grid">
        <div class="panel">
          <h3>Top Ad Sets by Spend</h3>
          <canvas id="metaLastSpendChart"></canvas>
        </div>
        <div class="panel">
          <h3>Top Ad Sets by Leads</h3>
          <canvas id="metaLastLeadsChart"></canvas>
        </div>
      </section>

      <section class="panel" style="margin-top:14px">
        <h3>Ad Set Performance (sorted by Leads)</h3>
        <div class="muted" style="margin-bottom:10px">Source: Meta Last Month (published CSV)</div>
        <div class="tableWrap">
          <table id="metaLastTable">
            <thead>
              <tr>
                <th>Campaign</th>
                <th>Ad Set</th>
                <th class="num">Spend</th>
                <th class="num">Leads</th>
                <th class="num">CPL</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- GOOGLE LAST MONTH (LITE) -->
    <section class="view" id="view-google-last">
      <section class="kpis">
        <div class="card"><div class="label">Google Spend</div><div class="value" id="gLastSpend">–</div></div>
        <div class="card"><div class="label">Google Leads</div><div class="value" id="gLastLeads">–</div></div>
        <div class="card"><div class="label">Google CPL</div><div class="value" id="gLastCpl">–</div></div>
        <div class="card"><div class="label">Budget Remaining</div><div class="value">–</div></div>
        <div class="card"><div class="label">% Budget Used</div><div class="value">–</div></div>
      </section>

      <section class="grid">
        <div class="panel">
          <h3>Top Ad Groups by Spend</h3>
          <canvas id="gLastSpendChart"></canvas>
        </div>
        <div class="panel">
          <h3>Top Ad Groups by Leads</h3>
          <canvas id="gLastLeadsChart"></canvas>
        </div>
      </section>

      <section class="panel" style="margin-top:14px">
        <h3>Ad Group Performance (sorted by Leads)</h3>
        <div class="muted" style="margin-bottom:10px">Source: Google Last Month (published CSV)</div>
        <div class="tableWrap">
          <table id="gLastTable">
            <thead>
              <tr>
                <th>Ad Group</th>
                <th class="num">Spend</th>
                <th class="num">Leads</th>
                <th class="num">CPL</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>

  </main>

  <script>
    // ====== CSV URLS (CURRENT - unchanged) ======
    const META_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaAQ-x37eMhwmwswWuQ89R6EW1DKxSD69UKqx8YXz2LxeSac0r8SSnWBKmO90BhbKpVFEC55I8RgyR/pub?gid=1218045846&single=true&output=csv";

    const GOOGLE_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaAQ-x37eMhwmwswWuQ89R6EW1DKxSD69UKqx8YXz2LxeSac0r8SSnWBKmO90BhbKpVFEC55I8RgyR/pub?gid=1321414260&single=true&output=csv";

    // ====== CSV URLS (LAST MONTH) ======
    const META_LAST_MONTH_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaAQ-x37eMhwmwswWuQ89R6EW1DKxSD69UKqx8YXz2LxeSac0r8SSnWBKmO90BhbKpVFEC55I8RgyR/pub?gid=2141513702&single=true&output=csv";

    const GOOGLE_LAST_MONTH_CSV_URL =
      "PASTE_GOOGLE_LAST_MONTH_CSV_URL_HERE";

    // ====== FORMAT HELPERS ======
    const money = (n) => Number(n || 0).toLocaleString("en-GB",{style:"currency",currency:"GBP"});
    const intFmt = (n) => Number(n || 0).toLocaleString("en-GB");

    function num(x){
      const v = String(x ?? "").replace(/£/g,"").replace(/,/g,"").trim();
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function isCurrencyLike(s){
      const t = String(s ?? "").trim();
      if (!t) return false;
      return /^£?\d+(\.\d+)?$/.test(t.replace(/,/g,""));
    }

    // ====== CSV PARSER ======
    function parseCsv(csvText){
      const rows = [];
      let row = [], field = "", inQuotes = false;
      for (let i = 0; i < csvText.length; i++){
        const c = csvText[i], next = csvText[i+1];
        if (c === '"' && inQuotes && next === '"'){ field += '"'; i++; continue; }
        if (c === '"'){ inQuotes = !inQuotes; continue; }
        if (c === ',' && !inQuotes){ row.push(field); field=""; continue; }
        if ((c === '\n' || c === '\r') && !inQuotes){
          if (field.length || row.length){ row.push(field); rows.push(row); }
          field=""; row=[];
          continue;
        }
        field += c;
      }
      if (field.length || row.length){ row.push(field); rows.push(row); }
      return rows.filter(r => r.some(x => String(x).trim() !== ""));
    }

    function normKey(k){
      return String(k || "")
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    function buildObjects(rows){
      const header = rows[0].map(h => normKey(h));
      const out = [];
      for (let i=1;i<rows.length;i++){
        const obj = {};
        for (let j=0;j<header.length;j++){
          obj[header[j]] = (rows[i][j] ?? "").trim();
        }
        out.push(obj);
      }
      return out;
    }

    // ====== TAB SWITCHING (4 tabs) ======
    const tabs = [
      { btn: document.getElementById("tab-meta"), view: document.getElementById("view-meta") },
      { btn: document.getElementById("tab-google"), view: document.getElementById("view-google") },
      { btn: document.getElementById("tab-meta-last"), view: document.getElementById("view-meta-last") },
      { btn: document.getElementById("tab-google-last"), view: document.getElementById("view-google-last") },
    ];

    function activateTab(index){
      tabs.forEach((t,i)=>{
        t.btn.classList.toggle("active", i===index);
        t.view.classList.toggle("active", i===index);
      });
    }
    tabs.forEach((t,i)=>t.btn.addEventListener("click", ()=>activateTab(i)));

    // ====== CHARTS ======
    let metaSpendChart, metaLeadsChart, gSpendChart, gLeadsChart;
    let metaLastSpendChart, metaLastLeadsChart, gLastSpendChart, gLastLeadsChart;

    function renderSpendChart(canvasId, labels, values){
      const ctx = document.getElementById(canvasId);
      return new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "£ Spent", data: values }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              title: { display: true, text: "£ Spent" },
              ticks: { callback: (value) => "£" + Number(value).toLocaleString("en-GB") }
            }
          }
        }
      });
    }

    function renderLeadsChart(canvasId, labels, values){
      const ctx = document.getElementById(canvasId);
      return new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Leads", data: values }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    // ====== META CURRENT (UNCHANGED LOGIC) ======
    function renderMeta(rows){
      const cleaned = rows.map(r => ({
        campaign: (r.campaign ?? "").trim(),
        ad_set: (r.ad_set ?? "").trim(),
        budget: (r.budget ?? "").trim(),
        spend: (r.spend ?? "").trim(),
        leads: (r.leads ?? "").trim(),
        cpl: (r.cpl ?? "").trim(),
        pace: (r.pace ?? "").trim(),
        delivery_strategy: (r.delivery_strategy ?? "").trim()
      }));

      let remaining = 0;

      const labeled = cleaned.find(r => r.campaign.toLowerCase().startsWith("monthly budget"));
      if (labeled) {
        remaining = num(labeled.ad_set) || num(labeled.budget) || num(labeled.spend);
      } else {
        const orphan = cleaned.find(r =>
          isCurrencyLike(r.campaign) &&
          !r.ad_set && !r.spend && !r.delivery_strategy
        ) || cleaned.find(r =>
          isCurrencyLike(r.ad_set) &&
          !r.campaign && !r.spend && !r.delivery_strategy
        );
        if (orphan) remaining = num(orphan.campaign || orphan.ad_set);
      }

      const totalRow = cleaned.find(r => r.campaign.toLowerCase() === "total budget & spend");
      const monthlyBudget = totalRow ? num(totalRow.budget) : 0;

      const detailRows = cleaned.filter(r => {
        if (!r.ad_set) return false;
        if (r.campaign.toLowerCase().startsWith("monthly budget")) return false;
        if (r.campaign.toLowerCase() === "total budget & spend") return false;
        if (r.campaign.toLowerCase() === "monthly budget remaining") return false;
        return true;
      });

      const totalSpend = detailRows.reduce((s,it)=>s+num(it.spend),0);
      const totalLeads = detailRows.reduce((s,it)=>s+num(it.leads),0);
      const cpl = totalLeads === 0 ? null : totalSpend / totalLeads;

      const inferredBudget = (monthlyBudget > 0) ? monthlyBudget : (remaining > 0 ? totalSpend + remaining : 0);
      const usedPct = inferredBudget > 0 ? (totalSpend / inferredBudget) * 100 : 0;

      document.getElementById("metaSpend").textContent = money(totalSpend);
      document.getElementById("metaLeads").textContent = intFmt(totalLeads);
      document.getElementById("metaCpl").textContent = cpl === null ? "–" : money(cpl);
      document.getElementById("metaRemaining").textContent = remaining ? money(remaining) : "–";
      document.getElementById("metaUsedPct").textContent = inferredBudget ? usedPct.toFixed(1) + "%" : "–";

      detailRows.sort((a,b) => num(b.leads) - num(a.leads));

      const tbody = document.querySelector("#metaTable tbody");
      tbody.innerHTML = "";
      for (const it of detailRows){
        const spend = num(it.spend);
        const leads = num(it.leads);
        const rowCpl = leads === 0 ? null : spend / leads;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.ad_set || "—"}</td>
          <td class="num">${money(spend)}</td>
          <td class="num">${intFmt(leads)}</td>
          <td class="num">${rowCpl === null ? "–" : money(rowCpl)}</td>
          <td>${it.pace || "—"}</td>
          <td>${it.delivery_strategy || "—"}</td>
        `;
        tbody.appendChild(tr);
      }

      const bySpend = [...detailRows]
        .map(it => ({ name: it.ad_set, v: num(it.spend) }))
        .sort((a,b)=>b.v-a.v).slice(0,8);

      const byLeads = [...detailRows]
        .map(it => ({ name: it.ad_set, v: num(it.leads) }))
        .sort((a,b)=>b.v-a.v).slice(0,8);

      if (metaSpendChart) metaSpendChart.destroy();
      if (metaLeadsChart) metaLeadsChart.destroy();

      metaSpendChart = renderSpendChart("metaSpendChart", bySpend.map(x=>x.name), bySpend.map(x=>x.v));
      metaLeadsChart = renderLeadsChart("metaLeadsChart", byLeads.map(x=>x.name), byLeads.map(x=>x.v));
    }

    // ====== GOOGLE CURRENT (UNCHANGED LOGIC) ======
    function renderGoogle(rows){
      const cleaned = rows
        .map(r => ({
          ad_group: (r.ad_group ?? "").trim(),
          spend: (r.spend ?? "").trim(),
          leads: (r.leads ?? "").trim(),
          cpl: (r.cpl ?? "").trim(),
          pace: (r.pace ?? "").trim(),
          delivery_strategy: (r.delivery_strategy ?? "").trim()
        }))
        .filter(r => r.ad_group !== "");

      let remaining = 0;
      const labeledRemaining = cleaned.find(r => r.ad_group.toLowerCase() === "monthly budget remaining");
      if (labeledRemaining) {
        remaining = num(labeledRemaining.spend);
      } else {
        const orphan = cleaned.find(r =>
          isCurrencyLike(r.ad_group) &&
          num(r.spend) === 0 &&
          num(r.leads) === 0 &&
          !r.delivery_strategy
        );
        if (orphan) remaining = num(orphan.ad_group);
      }

      const detailRows = cleaned.filter(r => {
        const ag = r.ad_group.toLowerCase();
        if (ag === "monthly budget remaining") return false;
        if (isCurrencyLike(r.ad_group) && num(r.spend) === 0 && num(r.leads) === 0 && !r.delivery_strategy) return false;
        return true;
      });

      const totalSpend = detailRows.reduce((s,it)=>s+num(it.spend),0);
      const totalLeads = detailRows.reduce((s,it)=>s+num(it.leads),0);
      const blendedCpl = totalLeads === 0 ? null : totalSpend / totalLeads;

      const inferredBudget = remaining > 0 ? (totalSpend + remaining) : 0;
      const usedPct = inferredBudget > 0 ? (totalSpend / inferredBudget) * 100 : 0;

      document.getElementById("gSpend").textContent = money(totalSpend);
      document.getElementById("gLeads").textContent = intFmt(totalLeads);
      document.getElementById("gCpl").textContent = blendedCpl === null ? "–" : money(blendedCpl);
      document.getElementById("gRemaining").textContent = remaining ? money(remaining) : "–";
      document.getElementById("gUsedPct").textContent = inferredBudget ? usedPct.toFixed(1) + "%" : "–";

      detailRows.sort((a,b) => num(b.leads) - num(a.leads));

      const tbody = document.querySelector("#gTable tbody");
      tbody.innerHTML = "";
      for (const it of detailRows){
        const spend = num(it.spend);
        const leads = num(it.leads);
        const rowCpl = leads === 0 ? null : spend / leads;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.ad_group || "—"}</td>
          <td class="num">${money(spend)}</td>
          <td class="num">${intFmt(leads)}</td>
          <td class="num">${rowCpl === null ? "–" : money(rowCpl)}</td>
          <td>${it.pace || "—"}</td>
          <td>${it.delivery_strategy || "—"}</td>
        `;
        tbody.appendChild(tr);
      }

      const bySpend = [...detailRows]
        .map(it => ({ name: it.ad_group, v: num(it.spend) }))
        .sort((a,b)=>b.v-a.v).slice(0,8);

      const byLeads = [...detailRows]
        .map(it => ({ name: it.ad_group, v: num(it.leads) }))
        .sort((a,b)=>b.v-a.v).slice(0,8);

      if (gSpendChart) gSpendChart.destroy();
      if (gLeadsChart) gLeadsChart.destroy();

      gSpendChart = renderSpendChart("gSpendChart", bySpend.map(x=>x.name), bySpend.map(x=>x.v));
      gLeadsChart = renderLeadsChart("gLeadsChart", byLeads.map(x=>x.name), byLeads.map(x=>x.v));
    }

    // ====== META LAST MONTH (LITE) ======
    function renderMetaLast(rows){
      const cleaned = rows.map(r => ({
        campaign: (r.campaign ?? "").trim(),
        ad_set: (r.ad_set ?? "").trim(),
        spend: (r.spend ?? "").trim(),
        leads: (r.leads ?? "").trim(),
        cpl: (r.cpl ?? "").trim()
      })).filter(r => r.campaign || r.ad_set);

      const detailRows = cleaned.filter(r => r.ad_set && r.campaign);

      const totalSpend = detailRows.reduce((s,it)=>s+num(it.spend),0);
      const totalLeads = detailRows.reduce((s,it)=>s+num(it.leads),0);
      const blendedCpl = totalLeads === 0 ? null : totalSpend / totalLeads;

      document.getElementById("metaLastSpend").textContent = money(totalSpend);
      document.getElementById("metaLastLeads").textContent = intFmt(totalLeads);
      document.getElementById("metaLastCpl").textContent = blendedCpl === null ? "–" : money(blendedCpl);

      detailRows.sort((a,b) => num(b.leads) - num(a.leads));

      const tbody = document.querySelector("#metaLastTable tbody");
      tbody.innerHTML = "";
      for (const it of detailRows){
        const spend = num(it.spend);
        const leads = num(it.leads);
        const rowCpl = leads === 0 ? null : spend / leads;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.campaign || "—"}</td>
          <td>${it.ad_set || "—"}</td>
          <td class="num">${money(spend)}</td>
          <td class="num">${intFmt(leads)}</td>
          <td class="num">${rowCpl === null ? "–" : money(rowCpl)}</td>
        `;
        tbody.appendChild(tr);
      }

      const bySpend = [...detailRows]
        .map(it => ({ name: it.ad_set, v: num(it.spend) }))
        .sort((a,b)=>b.v-a.v).slice(0,8);

      const byLeads = [...detailRows]
        .map(it => ({ name: it.ad_set, v: num(it.leads) }))
        .sort((a,b)=>b.v-a.v).slice(0,8);

      if (metaLastSpendChart) metaLastSpendChart.destroy();
      if (metaLastLeadsChart) metaLastLeadsChart.destroy();

      metaLastSpendChart = renderSpendChart("metaLastSpendChart", bySpend.map(x=>x.name), bySpend.map(x=>x.v));
      metaLastLeadsChart = renderLeadsChart("metaLastLeadsChart", byLeads.map(x=>x.name), byLeads.map(x=>x.v));
    }

    // ====== GOOGLE LAST MONTH (LITE) ======
    function renderGoogleLast(rows){
      const cleaned = rows.map(r => ({
        ad_group: (r.ad_group ?? "").trim(),
        spend: (r.spend ?? "").trim(),
        leads: (r.leads ?? "").trim(),
        cpl: (r.cpl ?? "").trim()
      })).filter(r => r.ad_group);

      const detailRows = cleaned.filter(r => r.ad_group);

      const totalSpend = detailRows.reduce((s,it)=>s+num(it.spend),0);
      const totalLeads = detailRows.reduce((s,it)=>s+num(it.leads),0);
      const blendedCpl = totalLeads === 0 ? null : totalSpend / totalLeads;

      document.getElementById("gLastSpend").textContent = money(totalSpend);
      document.getElementById("gLastLeads").textContent = intFmt(totalLeads);
      document.getElementById("gLastCpl").textContent = blendedCpl === null ? "–" : money(blendedCpl);

      detailRows.sort((a,b) => num(b.leads) - num(a.leads));

      const tbody = document.querySelector("#gLastTable tbody");
      tbody.innerHTML = "";
      for (const it of detailRows){
        const spend = num(it.spend);
        const leads = num(it.leads);
        const rowCpl = leads === 0 ? null : spend / leads;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.ad_group || "—"}</td>
          <td class="num">${money(spend)}</td>
          <td class="num">${intFmt(leads)}</td>
          <td class="num">${rowCpl === null ? "–" : money(rowCpl)}</td>
        `;
        tbody.appendChild(tr);
      }

      const bySpend = [...detailRows]
        .map(it => ({ name: it.ad_group, v: num(it.spend) }))
        .sort((a,b)=>b.v-a.v).slice(0,8);

      const byLeads = [...detailRows]
        .map(it => ({ name: it.ad_group, v: num(it.leads) }))
        .sort((a,b)=>b.v-a.v).slice(0,8);

      if (gLastSpendChart) gLastSpendChart.destroy();
      if (gLastLeadsChart) gLastLeadsChart.destroy();

      gLastSpendChart = renderSpendChart("gLastSpendChart", bySpend.map(x=>x.name), bySpend.map(x=>x.v));
      gLastLeadsChart = renderLeadsChart("gLastLeadsChart", byLeads.map(x=>x.name), byLeads.map(x=>x.v));
    }

    // ====== LOAD ======
    async function fetchCsvObjects(url){
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Failed to load CSV");
      const text = await res.text();
      if (text.trim().startsWith("<!DOCTYPE") || text.trim().startsWith("<html")){
        throw new Error("CSV URL returned HTML (not published or not public).");
      }
      const rows = parseCsv(text);
      return buildObjects(rows);
    }

    async function load(){
      try{
        const urlsToFetch = [
          fetchCsvObjects(META_CSV_URL),
          fetchCsvObjects(GOOGLE_CSV_URL),
          (META_LAST_MONTH_CSV_URL && !META_LAST_MONTH_CSV_URL.startsWith("PASTE_")) ? fetchCsvObjects(META_LAST_MONTH_CSV_URL) : Promise.resolve([]),
          (GOOGLE_LAST_MONTH_CSV_URL && !GOOGLE_LAST_MONTH_CSV_URL.startsWith("PASTE_")) ? fetchCsvObjects(GOOGLE_LAST_MONTH_CSV_URL) : Promise.resolve([]),
        ];

        const [metaRows, googleRows, metaLastRows, googleLastRows] = await Promise.all(urlsToFetch);

        renderMeta(metaRows);
        renderGoogle(googleRows);

        if (metaLastRows.length) renderMetaLast(metaLastRows);
        if (googleLastRows.length) renderGoogleLast(googleLastRows);

        document.getElementById("lastUpdated").textContent =
          "Updated: " + new Date().toLocaleString("en-GB");
      }catch(err){
        document.getElementById("lastUpdated").textContent = "Error loading data";
        console.error(err);
      }
    }

    load();
  </script>
</body>
</html>
